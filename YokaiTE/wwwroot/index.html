<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YokaiTE</title>
    <base href="/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />

    <link rel="icon" type="image/svg+xml" href="svg/logo.svg" />
    
    <link href="YokaiTE.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- Important: Increment the version parameter whenever you update MudBlazor to prevent caching issues -->
    <link href="_content/MudBlazor/MudBlazor.min.css?v=1" rel="stylesheet" />
    <link href="https://api.fontshare.com/v2/css?f[]=cabinet-grotesk@100,200,300,400,500,700,800,900&display=swap"
          rel="stylesheet">

</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">üóô</span>
    </div>
    <script src="_content/MudBlazor/MudBlazor.min.js?v=1"></script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="_content/TG.Blazor.IndexedDB/indexedDb.Blazor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/exportToPdf.js"></script>
    <script src="js/showOptions.js"></script>
    <script>navigator.serviceWorker.register('service-worker.js');</script>
    <script>
        window.getZenContent = function (element) {
            return element.innerHTML;

        }
        window.setZenContent = function (element, content) {
            element.innerHTML = content;
        }
    </script>
    <script>
        window.registerEditorShortcuts = function (dotNetHelper) {
            window.editorShortcutsHandler = function (e) {
                // Ctrl+S (Salvar)
                if ((e.ctrlKey || e.metaKey) && (e.key === "s" || e.key === "S")) {
                    e.preventDefault();
                    dotNetHelper.invokeMethodAsync('SalvarViaAtalho');
                }
                // Ctrl+B (Bold)
                if ((e.ctrlKey || e.metaKey) && (e.key === "b" || e.key === "B")) {
                    e.preventDefault();
                    window.applyBold();
                }
                // Ctrl+I (It√°lico)
                if ((e.ctrlKey || e.metaKey) && (e.key === "i" || e.key === "I")) {
                    e.preventDefault();
                    window.applyItalic();
                }

                if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
                    e.preventDefault();
                    printZenEditor();
                }

                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === "s" || e.key === "S")) {
                    e.preventDefault();
                    dotNetHelper.invokeMethodAsync('ExportSaveHaiku');
                }

                function ensurePrintStyle() {
                    if (document.getElementById('zen-print-style')) return;
                    const css = `
    @page { margin: 0; size: auto; }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; }
    .print-only { display: none; }
    @media print {
      /* Esconde todo o resto e mostra apenas o container de impress√£o */
      body > :not(.print-only) { display: none !important; }
      .print-only {
        display: block !important;
        padding: 24px !important;
        box-sizing: border-box !important;
        width: calc(100% - 48px) !important; /* 100% menos padding lateral */
        max-width: 100% !important;
        height: auto !important;
        margin: 0 !important;
        overflow: visible !important;
      }
      /* Evita que elementos internos excedam a largura e gerem scroll lateral */
      .print-only * {
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
      }
    }
  `;
                    const style = document.createElement('style');
                    style.id = 'zen-print-style';
                    style.appendChild(document.createTextNode(css));
                    document.head.appendChild(style);
                }

                function printZenEditor() {
                    const el = document.querySelector('.zen-editor');
                    if (!el) return;

                    ensurePrintStyle();

                    // Cria container oculto para impress√£o e insere clone do editor
                    const container = document.createElement('div');
                    container.className = 'print-only';
                    container.setAttribute('aria-hidden', 'true');
                    // Clona com true para copiar filhos
                    const clone = el.cloneNode(true);
                    // opcional: remover elementos interativos que n√£o interessam na impress√£o
                    clone.querySelectorAll('input, textarea, button, [contenteditable]').forEach(n => n.removeAttribute('contenteditable'));
                    container.appendChild(clone);
                    document.body.appendChild(container);

                    let cleaned = false;
                    function cleanUp() {
                        if (cleaned) return;
                        cleaned = true;
                        if (container.parentNode) container.parentNode.removeChild(container);
                        // n√£o removemos o estilo para reuso da fun√ß√£o
                        window.removeEventListener('afterprint', onAfterPrint);
                    }

                    function onAfterPrint() {
                        cleanUp();
                    }

                    window.addEventListener('afterprint', onAfterPrint);

                    // Fallback: remove se afterprint n√£o for disparado (alguns navegadores)
                    const fallback = setTimeout(() => {
                        cleanUp();
                        clearTimeout(fallback);
                    }, 2000);

                    // Pequeno delay para garantir carregamento de fontes/estilos
                    setTimeout(() => {
                        try {
                            window.print();
                        } catch (e) {
                            // alguns ambientes podem bloquear print; ainda manter cleanup via afterprint/fallback
                        }
                    }, 150);
                }

                // Exporta fun√ß√£o global para uso no registerEditorShortcuts existente
                window.printZenEditor = printZenEditor;
                
                
            };
            window.addEventListener('keydown', window.editorShortcutsHandler);
        };
        window.unregisterEditorShortcuts = function () {
            window.removeEventListener('keydown', window.editorShortcutsHandler);
        };
    </script>
    <script>
        window.addBeforeUnloadHandler = function () {
            window.onbeforeunload = function (e) {
                return "Voc√™ tem altera√ß√µes n√£o salvas. Tem certeza que deseja sair?";
            };
        };
        window.removeBeforeUnloadHandler = function () {
            window.onbeforeunload = null;
        };
    </script>
    <script>
        window.applyBold = function () {
            document.execCommand('bold');
        };
        window.applyItalic = function () {
            document.execCommand('italic');
        };
        window.applyUnderline = function () {
            document.execCommand('underline');
        };
        window.applyStrikethrough = function () {
            document.execCommand('strikeThrough');
        };
        // applyFontColor: function (color) {
        //     document.execCommand('foreColor', false, color);
        // },
        // applyHighlightColor: function (color) {
        //     document.execCommand('hiliteColor', false, color);
        // },
        // applyFontSize: function (size) {
        //     document.execCommand('fontSize', false, size); // 1-7 (HTML legacy)
        // },
        // applyFontFamily: function (font) {
        //     document.execCommand('fontName', false, font);
        // },
        window.applyTextAlign = function (align) {
            var command;
            switch (align) {
                case 'left':
                    command = 'justifyLeft';
                    break;
                case 'center':
                    command = 'justifyCenter';
                    break;
                case 'right':
                    command = 'justifyRight';
                    break;
                case 'full':
                    command = 'justifyFull';
                    break;
                default:
                    command = 'justifyLeft';
            }
            document.execCommand(command);
        };
        window.applyFontFamily = function (font) {
            document.execCommand('fontName', false, font);
        };

        window.applyFontSize = function (sizePx) {
            var selection = window.getSelection();
            if (!selection.rangeCount) return;

            var range = selection.getRangeAt(0);

            // Se h√° texto selecionado
            if (!range.collapsed) {
                var container = range.commonAncestorContainer;
                var walker = document.createTreeWalker(
                    container,
                    NodeFilter.SHOW_ELEMENT,
                    function(node) {
                        return range.intersectsNode && range.intersectsNode(node) ?
                            NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
                    }
                );

                var elementsToUpdate = [];
                var currentNode;
                while (currentNode = walker.nextNode()) {
                    if (currentNode.style && currentNode.style.fontSize) {
                        elementsToUpdate.push(currentNode);
                    }
                }

                elementsToUpdate.forEach(function(element) {
                    element.style.fontSize = '';
                    if (!element.style.cssText) {
                        element.removeAttribute('style');
                    }
                });

                var contents = range.extractContents();
                var span = document.createElement('span');
                span.style.fontSize = sizePx;
                span.appendChild(contents);
                range.insertNode(span);

                range.selectNodeContents(span);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                // Para cursor sem sele√ß√£o - aplica no elemento pai mais pr√≥ximo
                var focusNode = selection.focusNode;
                var element = focusNode.nodeType === 3 ? focusNode.parentElement : focusNode;

                // Se est√° no editor principal, cria um span
                if (element.classList.contains('zen-editor')) {
                    var span = document.createElement('span');
                    span.style.fontSize = sizePx;
                    span.innerHTML = '&#8203;'; // Zero-width space
                    range.insertNode(span);

                    range.setStart(span, 1);
                    range.setEnd(span, 1);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    // Aplica no elemento atual
                    element.style.fontSize = sizePx;
                }
            }
        };
    </script>
    <script>
        document.addEventListener('mousedown', function(e) {
            // Verifica se o clique est√° dentro da toolbar
            const toolbar = e.target.closest('.document-edit-top');
            if (toolbar) {
                // Exce√ß√µes: permitir comportamento normal em inputs e selects
                const isInput = e.target.tagName === 'INPUT' ||
                    e.target.tagName === 'SELECT' ||
                    e.target.tagName === 'TEXTAREA' ||
                    e.target.closest('input, select, textarea');

                if (!isInput) {
                    e.preventDefault();
                }
            }
        });
    </script>
    <script>
        window.setupZenEditorSpanWrapper = function(editorElement) {
            function createInitialSpan() {
                if (editorElement.innerHTML.trim() === '' ||
                    editorElement.innerHTML === '<br>' ||
                    editorElement.innerHTML === '<div><br></div>') {

                    var span = document.createElement('div');
                    span.style.fontSize = '18px';
                    span.innerHTML = '&#8203;'; // Zero-width space

                    editorElement.innerHTML = '';
                    editorElement.appendChild(span);

                    // Posiciona cursor no span
                    var selection = window.getSelection();
                    var range = document.createRange();
                    range.setStart(span, 1);
                    range.setEnd(span, 1);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }

            // Listener para quando foca no editor
            editorElement.addEventListener('focus', createInitialSpan);
        };
    </script>
    <script>
        window.saveFileFromBase64 = function(filename, base64, mimeType) {
            try {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for (let i = 0; i < byteChars.length; i++) {
                    byteNumbers[i] = byteChars.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: mimeType || 'application/octet-stream' });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'document.haiku';
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 5000);
            } catch (e) {
                console.error('saveFileFromBase64 error', e);
            }
        };
    </script>
    <script>
        // javascript
        window.haikuDrop = {
            _handlers: {},
            register: function(dotNetHelper, elementId) {
                const el = document.getElementById(elementId);
                const shadow = document.getElementById('shadow');
                if (!el || !shadow) return;

                let dragCounter = 0;

                const onDragEnter = function(e) {
                    e.preventDefault();
                    dragCounter++;
                    shadow.classList.add('active');
                    try { if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy'; } catch {}
                };

                const onDragOver = function(e) {
                    e.preventDefault();
                    try { if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy'; } catch {}
                };

                const onDragLeave = function(e) {
                    e.preventDefault();
                    dragCounter = Math.max(0, dragCounter - 1);
                    if (dragCounter === 0) {
                        shadow.classList.remove('active');
                    }
                };

                const onDrop = function(e) {
                    e.preventDefault();
                    dragCounter = 0;
                    shadow.classList.remove('active');

                    const files = e.dataTransfer && e.dataTransfer.files;
                    if (!files || files.length === 0) return;
                    const file = files[0];
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        const ab = evt.target.result;
                        const bytes = new Uint8Array(ab);
                        let binary = '';
                        const chunk = 0x8000;
                        for (let i = 0; i < bytes.length; i += chunk) {
                            binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
                        }
                        const base64 = btoa(binary);
                        dotNetHelper.invokeMethodAsync('ImportHaikuFromBase64', base64, file.name);
                    };
                    reader.readAsArrayBuffer(file);
                };

                const onDragEnd = function() {
                    dragCounter = 0;
                    shadow.classList.remove('active');
                };

                el.addEventListener('dragenter', onDragEnter);
                el.addEventListener('dragover', onDragOver);
                el.addEventListener('dragleave', onDragLeave);
                el.addEventListener('drop', onDrop);
                window.addEventListener('dragend', onDragEnd);

                this._handlers[elementId] = {
                    el, shadow,
                    onDragEnter, onDragOver, onDragLeave, onDrop, onDragEnd,
                    dotNetHelper
                };
            },

            unregister: function(elementId) {
                const h = this._handlers[elementId];
                if (!h) return;
                h.el.removeEventListener('dragenter', h.onDragEnter);
                h.el.removeEventListener('dragover', h.onDragOver);
                h.el.removeEventListener('dragleave', h.onDragLeave);
                h.el.removeEventListener('drop', h.onDrop);
                window.removeEventListener('dragend', h.onDragEnd);
                try { h.dotNetHelper.dispose(); } catch {}
                delete this._handlers[elementId];
            }
        };

    </script>

    <script>
        if (window.launchQueue && window.launchQueue.setConsumer) {
            window.launchQueue.setConsumer(async launchParams => {
                if (!launchParams || !launchParams.files || launchParams.files.length === 0) return;

                try {
                    // suportar FileSystemFileHandle (installed PWA) ou File direto
                    const handle = launchParams.files[0];
                    let file;
                    if (handle.getFile) {
                        file = await handle.getFile();
                    } else {
                        file = handle;
                    }

                    const ab = await file.arrayBuffer();
                    const bytes = new Uint8Array(ab);
                    let binary = '';
                    const chunk = 0x8000;
                    for (let i = 0; i < bytes.length; i += chunk) {
                        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
                    }
                    const base64 = btoa(binary);

                    // guardar temporariamente em localStorage com propriedades que o C# espera
                    localStorage.setItem('haikuImport', JSON.stringify({ Base64: base64, FileName: file.name }));

                    // navegar para a aplica√ß√£o (Home ir√° processar o import no OnAfterRender)
                    window.location.href = '/';
                } catch (err) {
                    console.error('haiku launch handler error', err);
                }
            });
        }
    </script>

    <script src="js/spellOverlay.js"></script>
    <script src="js/selectionState.js"></script>
    <script src="js/preview.js"></script>
</body>

</html>
